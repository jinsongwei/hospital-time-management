<!DOCTYPE HTML>
<html>
<head>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.120.0.min.js"></script>
    <script type="text/javascript">
        window.onload = function () {
            AWS.config.update({
                region: 'us-west-2',
                credentials: {
                    accessKeyId: "AKIAJELX7E74NLFTWCWA",
                    secretAccessKey: "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"
                }
            });
            AWS.config.apiVersions = {
                dynamodb: '2012-08-10',
            };
            let ddb = new AWS.DynamoDB({apiVersion: '2012-10-08'});
            const serviceList = [
                'General',
                'Ophthalmology',
                'Plastics',
                'Urology',
                'Orthopedics',
                'Neurosurgery',
                'Cardiothoracic',
                'Dental',
                'Transplant',
                'Vascular',
                'Radiation Oncology',
                'Pulmonology',
                'Anesthesiology'
            ];
            let chart = new CanvasJS.Chart("chartContainer", {
                title: {
                    text: "Hospital Schedule By Service"
                },
                axisY: {
                    includeZero: false,
                },
                legend: {
                    verticalAlign: "top",
                    horizontalAlign: "center",
                    fontSize: 14,
                    fontWeight: "bold",
                    fontFamily: "calibri",
                    fontColor: "dimGrey"
                },
                data: [
                    {
//					type: "stepLine",
                        type: "stepLine",
                        dataPoints: []
                    }, {
                        type: "stepLine",
                        dataPoints: []
                    },
                    {
                        type: "stepLine",
                        dataPoints: []
                    },
                    {
                        type: "stepLine",
                        dataPoints: []
                    },
                    {
                        type: "stepLine",
                        dataPoints: []
                    },
                    {
                        type: "stepLine",
                        dataPoints: []
                    },
                    {
                        type: "stepLine",
                        dataPoints: []
                    },
                    {
                        type: "stepLine",
                        dataPoints: []
                    },
                    {
                        type: "stepLine",
                        dataPoints: []
                    },
                    {
                        type: "stepLine",
                        dataPoints: []
                    },
                    {
                        type: "stepLine",
                        dataPoints: []
                    },
                    {
                        type: "stepLine",
                        dataPoints: []
                    },
                    {
                        type: "stepLine",
                        dataPoints: []
                    }
                ]
            });

            let updateChart = (i, callback) => {
                let data = chart.options.data;
                if (i < data.length) {
                    let params = {
                        ExpressionAttributeValues: {
                            ":v1": {
                                S: serviceList[i]
                            }
                        },
                        IndexName: "service_name-index",
                        KeyConditionExpression: "service_name = :v1",
                        ProjectionExpression: "sched_surgery_date_day",
                        TableName: "hos1_table"
                    };
                    ddb.query(params, (err, data) => {
                        if (err) {
                            console.error(err.stack);
                            callback(err);
                        }
                        else {
                            console.log(data);
                            let mapper = {};
                            let records = data.Items;
                            for (let i = 0; i < records.length; i++) {
                                let schedTime = parseInt(records[i].sched_surgery_date_day.N) * 86400000;
                                let keyTime = "T" + schedTime;
                                if (keyTime in mapper) {
                                    mapper[keyTime] += 1;
                                } else {
                                    mapper[keyTime] = 1;
                                }
                            }
                            chart.options.data[i].dataPoints = [];
                            for (let key in mapper) {
                                if (mapper.hasOwnProperty(key)) {
                                    chart.options.data[i].dataPoints.push({x: new Date(parseInt(key.substr(1))),y: mapper[key]});
                                }
                            }
                            chart.options.data[i]['legendText'] = serviceList[i];
                            updateChart(i+1,callback);
                        }
                    });
                }else{
                    chart.render();
                }
            };
            setInterval(function () {
                updateChart(0, err=>{
                    if(err) console.error(err);
                });
            }, 3000);
        }
    </script>
    <script type="text/javascript" src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
    <!--<script src="../../canvasjs.min.js"></script>-->
    <title>CanvasJS Example</title>
</head>

<body>
<div id="chartContainer" style="height: 400px; width: 100%;"></div>
</body>

</html>